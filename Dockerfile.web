# Simple single-stage image for the Web frontend.
FROM node:22-alpine

RUN corepack enable pnpm

WORKDIR /app

# Workspace manifests (keeps install cache-friendly)
COPY .npmrc pnpm-workspace.yaml pnpm-lock.yaml package.json ./
COPY apps/web/package.json ./apps/web/
COPY packages/contracts/package.json ./packages/contracts/
COPY packages/api-client/package.json ./packages/api-client/
COPY packages/offline-core/package.json ./packages/offline-core/
COPY packages/offline-web/package.json ./packages/offline-web/
COPY packages/tooling/tsconfig/package.json ./packages/tooling/tsconfig/
COPY packages/tooling/vite-config/package.json ./packages/tooling/vite-config/
COPY packages/tooling/tailwind-preset/package.json ./packages/tooling/tailwind-preset/

# Install all workspace deps
# Using shamefully-hoist for compatibility
RUN pnpm install --frozen-lockfile --recursive

# Copy source
COPY tsconfig.base.json tsconfig.web.json ./
COPY packages/tooling/tsconfig/*.json ./packages/tooling/tsconfig/
COPY packages ./packages
COPY apps/web ./apps/web

# Build packages that web depends on
# Note: @corely/api-client is source-only (no build needed)
# Build vite-config directly with tsdown from root node_modules
RUN cd packages/tooling/vite-config && /app/node_modules/.bin/tsdown \
 && cd /app && pnpm --filter @corely/contracts build \
 && pnpm --filter @corely/offline-core build \
 && pnpm --filter @corely/offline-web build

# Expose Vite dev server port
EXPOSE 8080

# Default environment
ENV NODE_ENV=development
ENV VITE_API_BASE_URL=http://localhost:3000

# Run Vite dev server bound to 0.0.0.0 (accessible from host)
WORKDIR /app/apps/web
CMD ["../../node_modules/.bin/vite", "--host", "0.0.0.0"]
