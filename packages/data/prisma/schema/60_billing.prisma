model Invoice {
  id          String        @id @default(cuid())
  tenantId    String
  customerId  String
  number      String?
  status      InvoiceStatus @default(DRAFT)
  currency    String
  notes       String?
  terms       String?
  invoiceDate DateTime?     @db.Date
  dueDate     DateTime?     @db.Date
  issuedAt    DateTime?     @db.Timestamptz(6)
  sentAt      DateTime?     @db.Timestamptz(6)
  createdAt   DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(6)

  lines     InvoiceLine[]
  payments  InvoicePayment[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@unique([tenantId, number])
}

model InvoiceLine {
  id             String   @id @default(cuid())
  invoiceId      String
  description    String
  qty            Int
  unitPriceCents Int

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoicePayment {
  id          String   @id @default(cuid())
  invoiceId   String
  amountCents Int
  paidAt      DateTime @db.Timestamptz(6)
  note        String?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  CANCELED
}

model InvoiceEmailDelivery {
  id                 String         @id @default(cuid())
  tenantId           String
  invoiceId          String
  to                 String
  status             DeliveryStatus @default(QUEUED)
  provider           String         @default("resend")
  providerMessageId  String?
  idempotencyKey     String
  lastError          String?
  createdAt          DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime       @updatedAt @db.Timestamptz(6)

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId, invoiceId])
  @@index([providerMessageId])
}

enum DeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
  DELAYED
}
