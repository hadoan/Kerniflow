// ===========================
// PLATFORM: APPS + TEMPLATES + PACKS
// Tenant Entitlements & Server-Driven Menu System
// ===========================

// =============================================================================
// APP CATALOG - Code definitions mirrored to DB for UI/querying
// =============================================================================

model AppCatalog {
  appId         String   @id
  name          String
  tier          Int      @default(0) // 0-7: app complexity tier
  version       String   // semver
  description   String?
  depsJson      String   // JSON: string[] of appIds this app depends on
  permissionsJson String // JSON: string[] of RBAC permission keys
  capabilitiesJson String // JSON: string[] of capability strings
  menuJson      String   // JSON: MenuContribution[]
  settingsSchemaJson String? // JSON: JSONSchema for tenant-specific app settings
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  @@index([tier])
  @@index([updatedAt])
}

// =============================================================================
// TENANT APP INSTALLATIONS
// =============================================================================

model TenantAppInstall {
  id               String   @id @default(cuid())
  tenantId         String   @map("tenant_id")
  appId            String   @map("app_id")
  enabled          Boolean  @default(false)
  installedVersion String   @map("installed_version")
  configJson       String?  @map("config_json") // JSON: tenant-specific app config
  enabledAt        DateTime? @map("enabled_at") @db.Timestamptz(6)
  enabledByUserId  String?  @map("enabled_by_user_id")
  disabledAt       DateTime? @map("disabled_at") @db.Timestamptz(6)
  disabledByUserId String?  @map("disabled_by_user_id")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, appId])
  @@index([tenantId, enabled])
  @@index([tenantId, createdAt])
}

// =============================================================================
// TEMPLATE CATALOG
// =============================================================================

model TemplateCatalog {
  templateId        String   @id @map("template_id")
  name              String
  category          String
  version           String   // semver
  description       String?
  requiresAppsJson  String   @map("requires_apps_json") // JSON: string[] of required appIds
  paramsSchemaJson  String   @map("params_schema_json") // JSON: JSONSchema/Zod descriptor for params
  upgradePolicyJson String   @map("upgrade_policy_json") // JSON: { skipCustomized, additiveOnly, etc }
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([category])
  @@index([updatedAt])
}

// =============================================================================
// TENANT TEMPLATE INSTALLATIONS
// Latest version wins: unique constraint on (tenantId, templateId)
// =============================================================================

model TenantTemplateInstall {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  templateId      String   @map("template_id")
  version         String   // version that was installed
  paramsJson      String   @map("params_json") // JSON: params used for this installation
  appliedByUserId String?  @map("applied_by_user_id")
  appliedAt       DateTime @map("applied_at") @db.Timestamptz(6)
  resultSummaryJson String? @map("result_summary_json") // JSON: diff/summary of changes made
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, templateId])
  @@index([tenantId, createdAt])
}

// =============================================================================
// PACK CATALOG
// =============================================================================

model PackCatalog {
  packId         String   @id @map("pack_id")
  name           String
  version        String   // semver
  description    String?
  definitionJson String   @map("definition_json") // JSON: full PackDefinition
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([updatedAt])
}

// =============================================================================
// TENANT PACK INSTALLATIONS
// Supports multiple versions: unique constraint on (tenantId, packId, version)
// =============================================================================

enum PackInstallStatus {
  PENDING
  RUNNING
  FAILED
  COMPLETED
}

model TenantPackInstall {
  id          String            @id @default(cuid())
  tenantId    String            @map("tenant_id")
  packId      String            @map("pack_id")
  version     String
  status      PackInstallStatus @default(PENDING)
  paramsJson  String?           @map("params_json") // JSON: params for pack installation
  logJson     String            @default("[]") @map("log_json") // JSON: append-only log entries array
  startedAt   DateTime?         @map("started_at") @db.Timestamptz(6)
  completedAt DateTime?         @map("completed_at") @db.Timestamptz(6)
  installedByUserId String?     @map("installed_by_user_id")
  errorJson   String?           @map("error_json") // JSON: safe error details (no secrets)
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, packId, version])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

// =============================================================================
// TENANT MENU OVERRIDES - Server-Driven Menu Customization
// =============================================================================

enum MenuScope {
  WEB
  POS
}

model TenantMenuOverride {
  id           String    @id @default(cuid())
  tenantId     String    @map("tenant_id")
  scope        MenuScope
  overridesJson String   @map("overrides_json") // JSON: { hidden: string[], order: Record<string,number>, renames: Record<string,string>, pins: string[] }
  updatedByUserId String? @map("updated_by_user_id")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, scope])
  @@index([tenantId])
}

// =============================================================================
// SEEDED RECORD META - Generic Template Customization Protection
// Tracks which records were seeded by templates to prevent upgrades from
// overwriting tenant customizations (inspired by Odoo's "noupdate" concept)
// =============================================================================

model SeededRecordMeta {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  targetTable       String   @map("target_table") // e.g., "ChartOfAccounts", "TaxRate"
  targetId          String   @map("target_id") // ID of the seeded record
  sourceTemplateId  String   @map("source_template_id")
  sourceTemplateVersion String @map("source_template_version")
  isCustomized      Boolean  @default(false) @map("is_customized")
  customizedAt      DateTime? @map("customized_at") @db.Timestamptz(6)
  customizedByUserId String? @map("customized_by_user_id")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, targetTable, targetId])
  @@index([tenantId, sourceTemplateId])
  @@index([tenantId, targetTable, isCustomized])
}
